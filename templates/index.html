{% extends "layout.html" %}
{% block title %}Herd Status{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Herd</h2>
    <a href="{{ url_for('add_cow') }}" class="btn btn-success">+ Add Cow</a>
  </div>

  <!-- Legend -->
  <div class="mb-3">
    <div class="badge-legend">
      <div class="legend-item"><span class="badge bg-success">Healthy</span><small class="text-muted ms-1">Normal</small></div>
      <div class="legend-item"><span class="badge bg-danger">Mastitis Risk</span><small class="text-muted ms-1">Udder inflammation</small></div>
      <div class="legend-item"><span class="badge bg-warning text-dark">Ketosis Risk</span><small class="text-muted ms-1">Metabolic</small></div>
      <div class="legend-item"><span class="badge bg-info text-dark">Metritis Risk</span><small class="text-muted ms-1">Postpartum</small></div>
      <div class="legend-item"><span class="badge bg-primary">Udder Infection</span><small class="text-muted ms-1">Severe udder</small></div>
    </div>
  </div>

  <ul class="list-group">
    {% for cow in cows %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a class="cow-link" href="{{ url_for('cow_dashboard', cow_id=cow['id']) }}">{{ cow['tag_id'] }} (Age: {{ cow['age'] }})</a>

          {% set raw_status = cow['last_status'] if cow['last_status'] else None %}
          {% set status_key = (raw_status|lower).strip() if raw_status else 'no_data' %}
          {% set status_key = status_key.replace(' ', '_').replace('-', '_') %}

          {% if status_key == 'healthy' %}
            <span class="badge bg-success ms-2">Healthy</span>
          {% elif status_key == 'mastitis_risk' %}
            <span class="badge bg-danger ms-2">Mastitis Risk</span>
          {% elif status_key == 'ketosis_risk' %}
            <span class="badge bg-warning text-dark ms-2">Ketosis Risk</span>
          {% elif status_key == 'metritis_risk' %}
            <span class="badge bg-info text-dark ms-2">Metritis Risk</span>
          {% elif status_key == 'udder_infection' %}
            <span class="badge bg-primary ms-2">Udder Infection</span>
          {% elif status_key == 'warning' %}
            <span class="badge bg-secondary ms-2">Warning</span>
          {% elif status_key == 'risk' %}
            <span class="badge bg-dark ms-2">High Risk</span>
          {% else %}
            <span class="badge bg-secondary ms-2">{{ (raw_status or 'No Data')|replace('_',' ')|title }}</span>
          {% endif %}
        </div>

        <div>
          <a class="btn btn-sm btn-outline-primary small-btn me-2" href="{{ url_for('connect', cow_id=cow['id']) }}">Listen</a>
          <!-- <a class="btn btn-sm btn-outline-success small-btn me-2" href="{{ url_for('add_record', cow_id=cow['id']) }}">Add Record</a> -->
          <a class="btn btn-sm btn-outline-warning small-btn me-2" href="{{ url_for('edit_cow', cow_id=cow['id']) }}">Edit</a>
          <form action="{{ url_for('delete_cow', cow_id=cow['id']) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-sm btn-outline-danger small-btn" onclick="return confirm('Delete this cow and all records?');">Delete</button>
          </form>
        </div>
      </li>
    {% else %}
      <li class="list-group-item">No cows. <a href="{{ url_for('add_cow') }}">Add one</a>.</li>
    {% endfor %}
  </ul>
{% endblock %}
